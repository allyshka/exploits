import socketserver
import socket

LOCAL_PORT = 9000
LOCAL_PORT_1 = 65123
HOST_FPM = '127,0,0,1'
HOST_VALID = '192.168.99.1'
HOST_VALID_FTP = '192,168,99,1'

first = True


class FakeFTP(socketserver.StreamRequestHandler):

    def _send(self, cmd):
        print(f'Sent "{cmd.decode()}"')
        self.wfile.write(cmd + b'\r\n')

    def RETR(self,cmd):
        global first
        self._send(b'150 Opening data connection.')
        print('Down: ', 'test.txt')
        # if self.mode=='I':
        self._send(b'226 Transfer complete.')
        first = False

    def handle(self):
        global first
        print('A new connection appears!')
        print(first)
        self._send(b'200 oh hai')
        while True:
            cmd = self.rfile.readline().rstrip()
            print(f'Got "{cmd.decode()}"')

            if cmd:
                raw_cmd = cmd
                cmd = cmd.split()[0]

            if cmd in (b'USER', b'TYPE'):
                self._send(b'200 ok')
            elif cmd == b'PWD':
                self._send(b'257 "/" is the current directory.')
            elif cmd in (b'SIZE'):
                # response file size
                if first == True:
                    self._send(b'213 5')
                else:
                    self._send(b'500 nope')
            elif cmd == b'EPSV':
                self._send(b'500 nope')
            elif cmd == b'PASV':
                if first == True:
                    self._send(f'227 Entering passive mode ({HOST_VALID_FTP},{LOCAL_PORT_1 // 256},{LOCAL_PORT_1 % 256})'.encode())
                else:
                    self._send(f'227 go to ({HOST_FPM},{LOCAL_PORT // 256},{LOCAL_PORT % 256})'.encode())
            elif cmd == b'STOR':
                self._send(b'150 do it!')
                self._send(b'226 nice knowing you')
            elif cmd == b'SYST':
                self._send(b'215 UNIX Type: L8')
            elif cmd == b'RETR':
                self.RETR(raw_cmd)
            elif cmd in (b'', b'QUIT'):
                print('All done!')
                break
            else:
                raise Exception('Unknown command')


if __name__ == '__main__':
    with socketserver.TCPServer(('', 21), FakeFTP) as server:
        print('Welcome to FakeFTP')
        server.serve_forever()
